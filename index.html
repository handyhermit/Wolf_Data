<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wolf Pack Movement Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root {
  --bg: #0f1115;
  --panel: #181b22;
  --text: #e6e8ee;
  --muted: #9aa0ad;
  --accent: #ff8c42;
  --border: #2a2f3a;
}

html, body {
  height: 100%;
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, sans-serif;
}

body {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header {
  padding: 12px 16px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  z-index: 10;
}

header h1 {
  margin: 0 0 4px;
  font-size: 18px;
}

header p {
  margin: 0;
  font-size: 13px;
  color: var(--muted);
}

#map {
  flex: 1;
}

#timeline {
  position: absolute;
  bottom: 12px;
  left: 12px;
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 10px;
  border-radius: 6px;
  z-index: 1000;
  width: 260px;
}

#dateLabel {
  font-size: 13px;
  margin-bottom: 6px;
  text-align: center;
}

input[type="range"] {
  width: 100%;
}

#tileSelector {
  position: absolute;
  top: 12px;
  right: 12px;
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 10px;
  border-radius: 6px;
  z-index: 1000;
}

@media (max-width: 768px) {
  #tileSelector {
    position: static;
    margin-top: 12px;
  }
  #timeline {
    bottom: 50px;
  }

  header {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
}
</style>
</head>

<body>

<header>
  <h1>Wolf Pack Movement Timeline</h1>
  <p>Drag the slider in the bottom left to view historical snapshots.</p>
</header>

<div id="map"></div>

<div id="timeline">
  <div id="dateLabel">Loading…</div>
  <input id="slider" type="range" min="0" step="1" value="0">
</div>

<div id="tileSelector">
  <label for="tileProvider" style="color: var(--text);">Tile Provider:</label>
  <select id="tileProvider">
    <option value="osm">OpenStreetMap</option>
    <option value="usgs">USGS Imagery Topo</option>
    <option value="esri">ESRI World Topo</option>
  </select>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  let hasAutoZoomed = false;

const map = L.map('map').setView([35.77, -118.82], 10);

const tileLayers = {
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 18
  }),
  usgs: L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20,
    attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'
  }),
  esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
})
};

let currentTileLayer = tileLayers.osm.addTo(map);

document.getElementById('tileProvider').addEventListener('change', (e) => {
  map.removeLayer(currentTileLayer);
  currentTileLayer = tileLayers[e.target.value].addTo(map);
});

let snapshots = [];
let layerGroup = L.layerGroup().addTo(map);

// Stable color per pack
function colorForPack(pack) {
  let hash = 0;
  for (let i = 0; i < pack.length; i++) {
    hash = pack.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${hash % 360}, 70%, 45%)`;
}

async function loadSnapshots() {
  const index = await fetch('data/index.json').then(r => r.json());
  console.log('Loaded index.json:', index);
  
  for (const file of index) {
    const geojson = await fetch(`data/${file}`).then(r => r.json());
    const date = file.match(/\d{4}-\d{2}-\d{2}/)?.[0] ?? file;

    snapshots.push({ date, geojson });
  }

  setupSlider();
  renderSnapshot(snapshots.length - 1);
}

function setupSlider() {
  const slider = document.getElementById('slider');
  slider.max = snapshots.length - 1;
  slider.value = snapshots.length - 1;

  slider.addEventListener('input', e => {
    renderSnapshot(parseInt(e.target.value, 10));
  });
}

function renderSnapshot(index) {
  layerGroup.clearLayers();

  const snap = snapshots[index];
  document.getElementById('dateLabel').textContent =
    `Snapshot: ${snap.date}`;

  const layer = L.geoJSON(snap.geojson, {
    style: feature => ({
      color: colorForPack(feature.properties?.pack ?? 'default'),
      weight: 2,
      fillOpacity: 0.35
    }),
    onEachFeature: (feature, layer) => {
      if (feature.properties) {
        layer.bindPopup(
          Object.entries(feature.properties)
            .map(([k,v]) => `<b>${k}</b>: ${v}`)
            .join('<br>')
        );
      }
    }
  }).addTo(layerGroup);

  // ✅ Auto-zoom ONLY once
  if (!hasAutoZoomed) {
    const bounds = layer.getBounds();
    if (bounds.isValid()) {
      map.fitBounds(bounds);
      hasAutoZoomed = true;
    }
  }
}

loadSnapshots();
</script>

</body>
</html>
